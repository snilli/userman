# Userman API

A robust user management REST API built with Go, Gin, and MongoDB. Features JWT authentication, clean architecture, and comprehensive testing.

## ğŸš€ Features

- **User Management**: Create, read, update, delete users
- **JWT Authentication**: Secure token-based authentication  
- **MongoDB Integration**: NoSQL database with optimized queries
- **Cursor-based Pagination**: Efficient data pagination
- **Clean Architecture**: Domain-driven design with clear separation of concerns
- **Comprehensive Testing**: Unit tests with high coverage
- **Docker Support**: Containerized deployment
- **Password Security**: Bcrypt hashing with validation rules

## ğŸ—ï¸ Architecture

```
â”œâ”€â”€ cmd/http/                    # Application entry point
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ application/            # Application services
â”‚   â”‚   â”œâ”€â”€ common/service/     # Shared services (pagination)
â”‚   â”‚   â””â”€â”€ user/              # User business logic
â”‚   â”œâ”€â”€ domain/                # Domain entities
â”‚   â”‚   â”œâ”€â”€ common/            # Base entities
â”‚   â”‚   â””â”€â”€ user/              # User domain
â”‚   â”œâ”€â”€ infrastructure/        # External services
â”‚   â”‚   â”œâ”€â”€ database/          # Database connection
â”‚   â”‚   â”œâ”€â”€ http/              # HTTP handlers
â”‚   â”‚   â”œâ”€â”€ jwt/               # JWT service
â”‚   â”‚   â””â”€â”€ repository/mongo/  # MongoDB repositories
â”‚   â””â”€â”€ interface/             # Interface adapters
â”‚       â”œâ”€â”€ grpc/              # gRPC handlers (future)
â”‚       â””â”€â”€ http/              # HTTP controllers
â”œâ”€â”€ docker-compose.yml         # Container orchestration
â”œâ”€â”€ Dockerfile                 # Container configuration
â””â”€â”€ Makefile                   # Build automation
```

## ğŸ› ï¸ Prerequisites

- Go 1.24+
- Docker & Docker Compose
- MongoDB (if running locally)

## ğŸš€ Quick Start

### 1. Clone the repository
```bash
git clone https://github.com/snilli/userman.git
cd userman
```

### 2. Environment Setup
Create `.env` file:
```env
# Application
GO_ENV=development
GIN_MODE=debug
PORT=8080

# Database
DB_MONGO_HOST=localhost
DB_MONGO_PORT=27017
DB_MONGO_USERNAME=admin
DB_MONGO_PASSWORD=password
DB_MONGO_DATABASE=userman

# JWT
JWT_SECRET=your-super-secret-jwt-key
JWT_EXPIRES=3600

# Local MongoDB URI
DB_MONGO_URI=mongodb://${DB_MONGO_USERNAME}:${DB_MONGO_PASSWORD}@${DB_MONGO_HOST}:${DB_MONGO_PORT}/${DB_MONGO_DATABASE}?authSource=admin
```

### 3. Run with Docker Compose (Recommended)
```bash
# Start all services
docker-compose up -d

# View logs
docker-compose logs -f app

# Stop services
docker-compose down
```

The API will be available at `http://localhost:8080`


## ğŸ“š API Documentation

### Authentication

#### Register User
```http
POST /auth/register
Content-Type: application/json

{
  "name": "John Doe",
  "email": "john@example.com", 
  "password": "Password123"
}
```

#### Login
```http
POST /auth/login
Content-Type: application/json

{
  "email": "john@example.com",
  "password": "Password123"
}
```

### User Management

#### Get All Users (Paginated)
```http
GET /users?limit=10&next_cursor=eyJ...
Authorization: Bearer <token>
```

#### Get User by ID
```http
GET /users/{id}
Authorization: Bearer <token>
```

#### Update User
```http
PUT /users/{id}
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "Jane Doe",
  "email": "jane@example.com"
}
```

#### Delete User
```http
DELETE /users/{id}
Authorization: Bearer <token>
```

## ğŸ§ª Testing

The project uses **interface-based testing** with **mockery** for automatic mock generation, ensuring clean and maintainable tests.

### Testing Architecture

#### Interface-Driven Design
```go
// Example: UserRepository interface
type UserRepository interface {
    Create(ctx context.Context, user *User) (*User, error)
    GetByID(ctx context.Context, id string) (*User, error)
    GetByEmail(ctx context.Context, email string) (*User, error)
    // ... other methods
}

// Implementation
type userRepository struct {
    collection *mongo.Collection
}

// Mock (auto-generated by mockery)
type MockUserRepository struct {
    mock.Mock
}
```

#### Mock Generation with Mockery
```bash
# Install mockery
go install github.com/vektra/mockery/v2@latest
# or
brew install mockery

# Generate mocks automatically
make generate-mocks
```

#### Test Structure
- **Unit Tests**: Test business logic using mocked dependencies
- **Interface Tests**: Verify interface contracts
- **Integration Tests**: Test with real MongoDB using testcontainers
- **HTTP Tests**: Test API endpoints with mocked services
### Run Tests
```bash
# Check total coverage
make total-coverage
```

### Generate Mocks
```bash
# Generate all mocks
make gen-mock
```

## ğŸ”§ Development

### Project Structure
- **Clean Architecture**: Domain â†’ Application â†’ Infrastructure â†’ Interface
- **Dependency Injection**: Using manual DI with interfaces
- **Repository Pattern**: Database abstraction layer
- **Service Layer**: Business logic separation

### Database Migrations
```bash
# Require golang-migrate
# If you don't have just install
brew install golang-migrate
# or
go install github.com/golang-migrate/migrate/v4

# Run migration db
make migrate-db
```

### Available Make Commands
```bash
make migrate-db          # migrate db when first run
make total-coverage      # Show total coverage percentage
make generate-mocks      # Generate test mocks
make run                 # Run application
```

### Metrics
- MongoDB connection status
- Application uptime
- User count logging (every 10 seconds)

## ğŸ” Security Features

### Password Requirements
- Minimum 8 characters
- At least one lowercase letter
- At least one uppercase letter  
- At least one number

### JWT Token
- HS256 signing algorithm
- Configurable expiration time
- User ID and role claims

## ğŸŒ Environment Variables

| Variable | Description | Default | Required |
|----------|-------------|---------|----------|
| `GO_ENV` | Environment mode | `development` | No |
| `GIN_MODE` | Gin framework mode | `debug` | No |
| `HTTP_PORT` | Application port | `8080` | No |
| `DB_MONGO_HOST` | MongoDB host | `localhost` | Yes |
| `DB_MONGO_USERNAME` | MongoDB username | `root` | Yes |
| `DB_MONGO_PASSWORD` | MongoDB password | - | Yes |
| `DB_MONGO_DATABASE` | MongoDB database name | `main_db` | Yes |
| `DB_MONGO_PORT` | MongoDB port | `27017` | Yes |
| `DB_MONGO_URI` | MongoDB connection string | - | Yes |
| `JWT_SECRET_KEY` | JWT signing secret | - | Yes |
| `JWT_EXPIRE_SEC` | JWT expiration (seconds) | `86400` | Yes |

### Development
```
go run cmd/http/main.go 
```

### Debug Mode
Set `GIN_MODE=debug` and `GO_ENV=development` for detailed logging.

## ğŸ“ˆ Performance

- **Cursor-based Pagination**: Efficient for large datasets
- **MongoDB Indexes**: Optimized queries on email and ID fields
- **JWT Stateless**: No server-side session storage
- **Docker Multi-stage**: Minimal production image size
